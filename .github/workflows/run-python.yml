name: è¿è¡ŒPythonè„šæœ¬  # å·¥ä½œæµåç§°
on:
  push:  # è§¦å‘æ¡ä»¶ï¼šä»£ç æ¨é€æ—¶è¿è¡Œ
    branches: [master]  # ç›®æ ‡åˆ†æ”¯ï¼ˆå¯ä¿®æ”¹ï¼‰
  schedule:
    - cron: '30 1 * * *'  # åŒ—äº¬æ—¶é—´æ¯å¤©ä¸Šåˆ9ç‚¹30åˆ†è¿è¡Œï¼ˆUTC+8 â†’ 1+8=9:30ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
jobs:
  run-script:
    runs-on: ubuntu-latest  # è¿è¡Œç¯å¢ƒ
    permissions:
      contents: write  # å…è®¸æäº¤ä»£ç åˆ°ä»“åº“
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4  # æ£€å‡ºä»“åº“ä»£ç 
      - name: é…ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # æŒ‡å®šä¸è„šæœ¬å…¼å®¹çš„Pythonç‰ˆæœ¬
          cache: 'pip'
      - name: å®‰è£…ä¾èµ–åº“
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt  # å®‰è£…ä¾èµ–
      - name: æ‰§è¡ŒPythonè„šæœ¬
        run: python app.py
      - name: ä¸Šä¼ çˆ¬è™«ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: comic  # å·¥ä»¶åç§°
          path: ./out/      # è¦ä¸Šä¼ çš„ç›®å½•/æ–‡ä»¶
          retention-days: 90   # ä¿ç•™å¤©æ•°1-90
          if-no-files-found: warn  # æ— æ–‡ä»¶æ—¶ä»…è­¦å‘Šä¸å¤±è´¥
      # å‘é€é‚®ä»¶
      - name: æ‰“åŒ…æ¼«ç”»æ–‡ä»¶
        id: pack
        run: |
          mkdir -p ./comic_pack
          zip -r ./comic_pack/comic_latest.zip ./out
          # è·å–å‹ç¼©åŒ…å¤§å°ï¼ˆå­—èŠ‚ï¼‰
          file_size=$(stat -c%s "./comic_pack/comic_latest.zip")
          echo "å‹ç¼©åŒ…å¤§å°: $file_size å­—èŠ‚ ($(($file_size/1024/1024)) MB)"
          # è®¾ç½®é˜ˆå€¼ï¼š45MB = 45*1024*1024 = 47185920 å­—èŠ‚
          threshold=47185920
          if [ -z "${{ secrets.EMAIL_USERNAME }}" ]; then
            echo "æœªè®¾ç½®é‚®ç®±ï¼Œä¸å‘é€é‚®ä»¶"
            echo "should_send=NO" >> $GITHUB_OUTPUT
          elif [ $file_size -gt $threshold ]; then
            echo "æ–‡ä»¶å¤§å°è¶…è¿‡ä¸Šé™ï¼Œä¸å‘é€é‚®ä»¶"
            echo "should_send=false" >> $GITHUB_OUTPUT
          else
            echo "æ–‡ä»¶å¤§å°æœªè¶…è¿‡ä¸Šé™ï¼Œå‘é€é™„ä»¶"
            echo "should_send=true" >> $GITHUB_OUTPUT
          fi
          # åŒæ—¶ä¿å­˜å®é™…å¤§å°
          echo "size=$file_size" >> $GITHUB_OUTPUT
          echo "size_mb=$(($file_size/1024/1024))" >> $GITHUB_OUTPUT
      - name: æ¼«ç”»ä¸‹è½½æˆåŠŸé€šçŸ¥(45MBä»¥å†…å‘é€é™„ä»¶)
        uses: dawidd6/action-send-mail@v3
        if: steps.pack.outputs.should_send == 'true'  # åªæœ‰åœ¨should_sendä¸ºtrueæ—¶æ‰å‘é€
        with:
          server_address: smtp.163.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject:
            ã€æ¯æ—¥æ¼«ç”»æ¨é€ã€‘
          body: |
            ğŸ“¥ æœ¬æ¬¡æ¼«ç”»ä¸‹è½½ä»»åŠ¡å·²å®Œæˆï¼
            â”œâ”€ è¿è¡Œæ—¶é—´ï¼š${{ steps.size.outputs.run_date }}
            â”œâ”€ æ‰“åŒ…å¤§å°ï¼š${{ steps.pack.outputs.size_mb }} MB
            â”œâ”€ ä¸‹è½½åœ°å€ï¼š${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            â””â”€ æœ‰æ•ˆæœŸï¼š90å¤©

            ğŸ“Œ è§£å‹è¯´æ˜ï¼š
            1. å°†æ‰€æœ‰åˆ†å·æ–‡ä»¶æ”¾åœ¨åŒä¸€ç›®å½•
            2. æ‰§è¡Œå‘½ä»¤ï¼šunzip comic_latest.zip
            3. è‹¥è§£å‹å¤±è´¥ï¼Œå°è¯•ï¼šzip -F comic_latest.zip --out comic_merged.zip && unzip comic_merged.zip

            ğŸ“¥é¡¹ç›®åœ°å€:https://github.com/mkktop/mkk_comic
          to: ${{ secrets.TARGET_EMAIL }}
          from: mkk_comicè®¢é˜…æ¨é€
          attachments: ./comic_pack/comic_latest.zip
          secure: true

      - name: æ¼«ç”»ä¸‹è½½æˆåŠŸé€šçŸ¥(è¶…è¿‡45MBä¸å‘é€é™„ä»¶)
        if: steps.pack.outputs.should_send == 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.163.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ã€æ¯æ—¥æ¼«ç”»æ¨é€ã€‘
          body: |
            ğŸ“­ æœ¬æ¬¡æ¼«ç”»ä¸‹è½½ä»»åŠ¡å·²å®Œæˆï¼Œé™„ä»¶è¿‡å¤§è¯·æ‰‹åŠ¨ä¸‹è½½ã€‚
            â”œâ”€ è¿è¡Œæ—¶é—´ï¼š${{ steps.size.outputs.run_date }}
            â”œâ”€ æ‰“åŒ…å¤§å°ï¼š${{ steps.pack.outputs.size_mb }} MB
            â”œâ”€ ä¸‹è½½åœ°å€ï¼š${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            â””â”€ æœ‰æ•ˆæœŸï¼š90å¤©

            ğŸ“¥ é¡¹ç›®åœ°å€ï¼šhttps://github.com/mkktop/mkk_comic
            å¦‚éœ€æ‰‹åŠ¨æ£€æŸ¥ï¼Œè¯·è®¿é—®é¡¹ç›®ä»“åº“æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚
          to: ${{ secrets.TARGET_EMAIL }}
          from: mkk_comicè®¢é˜…æ¨é€
          secure: true
      - name: æäº¤é…ç½®åˆ°Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add ./config/*
          git add ./logs/*
          git commit -m "Add config or log $(date +'%Y-%m-%d_%H-%M-%S')" || echo "æ— æ–°æ—¥å¿—éœ€æäº¤"
          git push origin master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
