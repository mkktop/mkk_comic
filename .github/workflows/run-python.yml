name: è¿è¡ŒPythonè„šæœ¬  # è‡ªå®šä¹‰å·¥ä½œæµåç§°
on:
  push:  # è§¦å‘æ¡ä»¶ï¼šä»£ç æ¨é€æ—¶è¿è¡Œ
    branches: [master]  # ç›®æ ‡åˆ†æ”¯ï¼ˆå¯ä¿®æ”¹ï¼‰
  schedule:
    - cron: '0 18 * * *'  # åŒ—äº¬æ—¶é—´æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œï¼ˆUTC+8 â†’ 18+8=2ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
jobs:
  run-script:
    runs-on: ubuntu-latest  # è¿è¡Œç¯å¢ƒï¼ˆå¯é€‰windows-latest/macos-latestï¼‰
    permissions:
      contents: write  # å…è®¸æäº¤ä»£ç åˆ°ä»“åº“
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4  # æ£€å‡ºä»“åº“ä»£ç 
      - name: é…ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # æŒ‡å®šä¸è„šæœ¬å…¼å®¹çš„Pythonç‰ˆæœ¬
          cache: 'pip'  # å¯é€‰ï¼šç¼“å­˜ä¾èµ–åŠ é€Ÿå®‰è£…
      - name: å®‰è£…ä¾èµ–åº“
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt  # å®‰è£…ä¾èµ–
      - name: æ‰§è¡ŒPythonè„šæœ¬
        run: python app.py  # æ›¿æ¢ä¸ºä½ çš„è„šæœ¬æ–‡ä»¶å
      # æ‰§è¡Œè„šæœ¬æ­¥éª¤åæ·»åŠ 
      - name: ä¸Šä¼ çˆ¬è™«ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: comic  # å·¥ä»¶åç§°ï¼ˆè‡ªå®šä¹‰ï¼‰
          path: ./out/      # è¦ä¸Šä¼ çš„ç›®å½•/æ–‡ä»¶
          retention-days: 90   # ä¿ç•™å¤©æ•°1-90ï¼Œé»˜è®¤30å¤©
          if-no-files-found: warn  # æ— æ–‡ä»¶æ—¶ä»…è­¦å‘Šä¸å¤±è´¥
      # åˆ†å·æ‰“åŒ…
      - name: åˆ†å·æ‰“åŒ…æ¼«ç”»æ–‡ä»¶
        if: ${{ secrets.EMAIL_USERNAME }} != '' && ${{ secrets.EMAIL_PASSWORD }} != '' && ${{ secrets.TARGET_EMAIL }} != ''
        run: |
          # åˆ›å»ºæ‰“åŒ…ç›®å½•
          mkdir -p ./comic_pack
          # åˆ†å·æ‰“åŒ…ï¼šæ¯å·2.8GBï¼ˆè§„é¿QQä¸­è½¬ç«™3GBä¸Šé™ï¼‰ï¼Œè¾“å‡ºåˆ°packç›®å½•
          # è‹¥æ–‡ä»¶å°äº50MBï¼Œè‡ªåŠ¨ç”Ÿæˆå•æ–‡ä»¶ï¼›å¤§äºåˆ™åˆ†å·
          zip -r -s 2800m ./comic_pack/comic_latest.zip ./out
          # æŸ¥çœ‹æ‰“åŒ…ç»“æœ
          ls -lh ./comic_pack/
      # æ­¥éª¤7ï¼šå‘é€é‚®ä»¶ï¼ˆé™„å¸¦æ‰€æœ‰åˆ†å·æ–‡ä»¶ï¼‰
      - name: å‘é€è¶…å¤§é™„ä»¶é‚®ä»¶
        if: ${{ secrets.EMAIL_USERNAME }} != '' && ${{ secrets.EMAIL_PASSWORD }} != '' && ${{ secrets.TARGET_EMAIL }} != ''
        uses: dawidd6/action-send-mail@v3
        with:
          # QQé‚®ç®±SMTPé…ç½®ï¼ˆå›ºå®šï¼‰
          server_address: smtp.163.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }} # å‘ä»¶äººé‚®ç®±
          password: ${{ secrets.EMAIL_PASSWORD }} #
          # é‚®ä»¶å†…å®¹
          subject: ã€æ¼«ç”»æ›´æ–°ã€‘${{ steps.size.outputs.run_date }}
          body: |
            ğŸ“¥ æœ¬æ¬¡æ¼«ç”»ä¸‹è½½ä»»åŠ¡å·²å®Œæˆï¼
            â”œâ”€ è¿è¡Œæ—¶é—´ï¼š${{ steps.size.outputs.run_date }}
            â”œâ”€ æ‰“åŒ…åˆ†å·ï¼šæ¯å·2.8GB
            â”œâ”€ ä¿å­˜è·¯å¾„ï¼š./out/
            â”œâ”€ å¤‡ç”¨ä¸‹è½½ï¼š${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            â””â”€ æœ‰æ•ˆæœŸï¼š15å¤©

            ğŸ“Œ è§£å‹è¯´æ˜ï¼š
            1. å°†æ‰€æœ‰åˆ†å·æ–‡ä»¶æ”¾åœ¨åŒä¸€ç›®å½•
            2. æ‰§è¡Œå‘½ä»¤ï¼šunzip comic_latest.zipï¼ˆè‡ªåŠ¨åˆå¹¶åˆ†å·ï¼‰
            3. è‹¥è§£å‹å¤±è´¥ï¼Œå°è¯•ï¼šzip -F comic_latest.zip --out comic_merged.zip && unzip comic_merged.zip
            
            ğŸ“¥é¡¹ç›®åœ°å€:https://github.com/mkktop/mkk_comic
          # æ”¶ä»¶äººï¼ˆå¯å¡«å¤šä¸ªï¼Œç”¨é€—å·åˆ†éš”ï¼‰
          to: ${{ secrets.TARGET_EMAIL }}
          # å‘ä»¶äººæ˜¾ç¤ºåç§°
          from: mkk_comic è‡ªåŠ¨åŒæ­¥
          # é™„ä»¶ï¼šåŒ¹é…æ‰€æœ‰åˆ†å·æ–‡ä»¶ï¼ˆ.zip/.z01/.z02...ï¼‰
          attachments: ./comic_pack/comic_latest.z*
          # å¯ç”¨TLSåŠ å¯†ï¼ˆå¿…é¡»ï¼‰
          secure: true
      - name: æäº¤é…ç½®åˆ°Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add ./config/*
          git commit -m "Add config or log $(date +'%Y-%m-%d_%H-%M-%S')" || echo "æ— æ–°æ—¥å¿—éœ€æäº¤"
          git push origin master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}